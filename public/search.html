<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche d'etablissements en France | MeilleureEcole.fr</title>
    <meta id="metaDescription" name="description" content="Recherchez des etablissements scolaires en France par nom, commune ou code postal. Filtrez selon le niveau, le statut ou la note moyenne." />
    <meta name="robots" content="noindex,follow" />
    <link rel="canonical" href="https://www.meilleureecole.fr/search" id="canonicalLink" />
    <link rel="alternate" href="https://www.meilleureecole.fr/search" hreflang="fr-fr" id="alternateLink" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="theme-color" content="#2563eb" />
    <meta property="og:site_name" content="MeilleureEcole.fr" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Recherche d'etablissements en France | MeilleureEcole.fr" id="ogTitle" />
    <meta property="og:description" content="Decouvrez des etablissements scolaires en France selon la commune, l'academie ou la note moyenne avec MeilleureEcole.fr." id="ogDescription" />
    <meta property="og:url" content="https://www.meilleureecole.fr/search" id="ogUrl" />
    <meta property="og:image" content="https://www.meilleureecole.fr/images/findschool-social.png" />
    <meta property="og:image:alt" content="MeilleureEcole.fr social preview card" />
    <meta property="og:locale" content="fr_FR" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Recherche d'etablissements en France | MeilleureEcole.fr" id="twitterTitle" />
    <meta name="twitter:description" content="Trouvez rapidement un etablissement proche grace au moteur de recherche MeilleureEcole.fr." id="twitterDescription" />
    <meta name="twitter:image" content="https://www.meilleureecole.fr/images/findschool-social.png" />
    <meta name="twitter:image:alt" content="MeilleureEcole.fr social preview card" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    <script type="application/ld+json" id="structuredData">
      {}
    </script>
    
    <style>
        .search-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        
        .search-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .search-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        /* Filters Sidebar */
        .filters-sidebar {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 1rem;
        }
        
        .filter-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .filter-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .filter-title {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.75rem;
        }
        
        .filter-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .filter-checkbox-group {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .filter-checkbox {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            cursor: pointer;
        }
        
        .filter-checkbox input {
            margin-right: 0.5rem;
        }
        
        .filter-checkbox label {
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151;
            flex: 1;
        }
        
        .filter-count {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: 0.5rem;
        }
        
        .filter-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            cursor: pointer;
        }
        
        .filter-rating input {
            margin-right: 0.5rem;
        }
        
        .rating-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .rating-badge.outstanding {
            background: #d1fae5;
            color: #065f46;
        }
        
        .rating-badge.good {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .rating-badge.requires-improvement {
            background: #fed7aa;
            color: #92400e;
        }
        
        .rating-badge.inadequate {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .clear-filters {
            width: 100%;
            padding: 0.5rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .clear-filters:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }
        
        /* Results Section */
        .results-section {
            min-height: 500px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .results-info {
            color: #4b5563;
            font-size: 0.875rem;
        }
        
        .results-info strong {
            color: #111827;
            font-size: 1rem;
        }
        
        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }
        
        .view-btn {
            padding: 0.5rem 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        
        .view-btn:hover:not(.active) {
            background: #f9fafb;
        }
        
        /* Map Container */
        #schoolsMap {
            height: 600px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            display: none;
            position: relative;
        }
        
        #schoolsMap.active {
            display: block;
        }
        
        /* Map Search Button */
        .map-search-control {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        
        .map-search-control:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: #f9fafb;
        }
        
        .map-search-control.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        /* School Marker */
        .school-marker {
            background: white;
            border: 2px solid #2563eb;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .school-marker.excellent {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        
        .school-marker.good {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .school-marker.average {
            background: #fbbf24;
            border-color: #fbbf24;
            color: #92400e;
        }
        
        .school-marker.poor {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }
        
        /* Custom marker cluster styles */
        .marker-cluster {
            background-clip: padding-box;
            border-radius: 20px;
        }
        
        .marker-cluster div {
            background-color: rgba(37, 99, 235, 0.8);
            border-radius: 15px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }
        
        .marker-cluster-small {
            background-color: rgba(37, 99, 235, 0.6);
        }
        
        .marker-cluster-medium {
            background-color: rgba(37, 99, 235, 0.7);
        }
        
        .marker-cluster-medium div {
            width: 40px;
            height: 40px;
        }
        
        .marker-cluster-large {
            background-color: rgba(37, 99, 235, 0.8);
        }
        
        .marker-cluster-large div {
            width: 50px;
            height: 50px;
        }
        
        /* Results List */
        #resultsList {
            display: none;
        }
        
        #resultsList.active {
            display: block;
        }
        
        .school-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .school-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .school-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .school-card-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
        }
        
        .school-card-type {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .school-card-rating {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }
        
        .rating-excellent {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .rating-good {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .rating-satisfactory {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }
        
        .rating-poor {
            background: linear-gradient(135deg, #f87171, #ef4444);
        }
        
        .rating-average {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
        }
        
        .school-card-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .detail-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            min-width: 110px;
            text-transform: uppercase;
        }

        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        /* No Results */
        .no-results {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .no-results h3 {
            color: #111827;
            margin-bottom: 1rem;
        }
        
        .no-results p {
            color: #6b7280;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        
        .page-btn {
            padding: 0.5rem 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 40px;
            text-align: center;
        }
        
        .page-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        
        .page-btn:hover:not(.active):not(:disabled) {
            background: #f9fafb;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .search-container {
                grid-template-columns: 1fr;
            }
            
            .filters-sidebar {
                position: static;
                margin-bottom: 2rem;
            }
            
            .view-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header"></div>
    
    <!-- Search Header -->
    <section class="search-header">
        <div class="container">
            <h1 id='pageTitle'>Rechercher un etablissement</h1>
            <p id='searchSubtitle'>Trouvez l'etablissement adapte a votre projet</p>
        </div>
    </section>
    
    <!-- Search Content -->
    <div class="container">
        <div class="search-container">
            <!-- Filters Sidebar -->
            <aside class="filters-sidebar">
                <div class="filter-section">
                    <h3 class="filter-title">Recherche</h3>
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="filter-input" 
                        placeholder="Nom de l'etablissement ou code postal..."
                    />
                </div>
                
                <div class="filter-section">
                    <h3 class="filter-title">Localisation</h3>
                    <input 
                        type="text" 
                        id="locationInput" 
                        class="filter-input" 
                        placeholder="Commune, departement ou region..."
                    />
                </div>
                
                <div class="filter-section">
                    <h3 class="filter-title">Type d'etablissement</h3>
                    <div class="filter-checkbox-group" id="schoolTypeFilters">
                        <div class="filter-checkbox">
                            <input type="checkbox" id="type-ecole" value="ecole">
                            <label for="type-ecole">Ecoles maternelles et elementaires</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="type-college" value="college">
                            <label for="type-college">Colleges</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="type-lycee" value="lycee">
                            <label for="type-lycee">Lycees et lycees professionnels</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="type-specialise" value="specialise">
                            <label for="type-specialise">Etablissements specialises et medico-sociaux</label>
                        </div>
                    </div>
                </div>
                
                
                <div class="filter-section">
                    <h3 class="filter-title">Statut de l'etablissement</h3>
                    <div id="statusFilters">
                        <div class="filter-checkbox">
                            <input type="checkbox" id="status-public" value="public">
                            <label for="status-public">Public</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="status-prive" value="prive">
                            <label for="status-prive">Prive</label>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="filter-title">Autres criteres</h3>
                    <div id="flagFilters" class="filter-checkbox-group">
                        <div class="filter-checkbox">
                            <input type="checkbox" id="voie-generale" value="voie_generale">
                            <label for="voie-generale">Voie generale</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="voie-technologique" value="voie_technologique">
                            <label for="voie-technologique">Voie technologique</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="voie-professionnelle" value="voie_professionnelle">
                            <label for="voie-professionnelle">Voie professionnelle</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-restauration" value="restauration">
                            <label for="flag-restauration">Restauration</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-hebergement" value="hebergement">
                            <label for="flag-hebergement">Hebergement</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-ulis" value="ulis">
                            <label for="flag-ulis">ULIS</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-segpa" value="segpa">
                            <label for="flag-segpa">SEGPA</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-apprentissage" value="apprentissage">
                            <label for="flag-apprentissage">Apprentissage</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-section-arts" value="section_arts">
                            <label for="flag-section-arts">Section Arts</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-section-cinema" value="section_cinema">
                            <label for="flag-section-cinema">Section Cinema</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-section-theatre" value="section_theatre">
                            <label for="flag-section-theatre">Section Theatre</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-section-sport" value="section_sport">
                            <label for="flag-section-sport">Section Sport</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-section-internationale" value="section_internationale">
                            <label for="flag-section-internationale">Section Internationale</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-section-europeenne" value="section_europeenne">
                            <label for="flag-section-europeenne">Section Europeenne</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-lycee-agricole" value="lycee_agricole">
                            <label for="flag-lycee-agricole">Lycee Agricole</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-lycee-militaire" value="lycee_militaire">
                            <label for="flag-lycee-militaire">Lycee Militaire</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="flag-lycee-metiers" value="lycee_des_metiers">
                            <label for="flag-lycee-metiers">Lycee des metiers</label>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="filter-title">Note moyenne des avis</h3>
                    <div>
                        <label for="ratingRange" style="font-size: 0.875rem; color: #6b7280;">
                            Note minimale : <span id="ratingValue">1</span>/5
                        </label>
                        <input 
                            type="range" 
                            id="ratingRange" 
                            min="1" 
                            max="5" 
                            step="0.5" 
                            value="1"
                            style="width: 100%; margin-top: 0.5rem;"
                        />
                    </div>
                </div>
                
                <button class="clear-filters" type="button">Reinitialiser les filtres</button>
            </aside>
            
            <!-- Results Section -->
            <div class="results-section">
                <div class="results-header">
                    <div class="results-info">
                        <strong id="resultsCount">0</strong> etablissements trouves
                    </div>
                    <div class="view-toggle">
                        <button class="view-btn active" type="button" onclick="toggleView('list')">Liste</button>
                        <button class="view-btn" type="button" onclick="toggleView('map')">Carte</button>
                    </div>
                </div>
                
                <!-- Map View -->
                <div id="schoolsMap"></div>
                
                <!-- List View -->
                <div id="resultsList" class="active">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des etablissements...</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div id="footer"></div>
    
    <!-- Leaflet JS for Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Scripts -->
    <script src="/js/main.js"></script>
    <script>
        // Global variables
        let currentPage = 1;
        const resultsPerPage = 20;
        let totalResults = 0;
        let searchResults = [];
        let map = null;
        let markers = L.markerClusterGroup();
        let currentView = 'list';
        let isMapInitialized = false;

        function buildFullUrl() {
            const { pathname, search } = window.location;
            return `https://www.meilleureecole.fr${pathname}${search || ''}`;
        }

        const FILTER_TYPE_OPTIONS = new Set(['ecole', 'college', 'lycee', 'specialise']);

        function updateSearchMeta({ query, area, type, total }) {
            const canonical = document.getElementById('canonicalLink');
            const alternate = document.getElementById('alternateLink');
            const ogUrl = document.getElementById('ogUrl');

            const pageUrl = buildFullUrl();
            const searchTerm = (query || area || '').trim();
            const typeTitle = type ? getTypeTitle(type) : null;
            let title = "Recherche d'etablissements en France | MeilleureEcole.fr";
            let description = "Recherchez des etablissements scolaires en France par nom, commune ou code postal. Filtrez selon le niveau, le statut ou la note moyenne.";

            if (searchTerm) {
                const countText = total ? `${total} etablissement${total === 1 ? '' : 's'}` : 'etablissements';
                title = `${searchTerm} | MeilleureEcole.fr`;
                description = `Consultez ${countText} pour ${searchTerm} sur MeilleureEcole.fr. Comparez les notes moyennes, les resultats et les avis de parents.`;
            } else if (typeTitle) {
                const countText = total ? `${total} ${typeTitle.toLowerCase()}` : typeTitle.toLowerCase();
                title = `${typeTitle} en France | MeilleureEcole.fr`;
                description = `Explorez ${countText} en France. Affinez les resultats selon la note moyenne, le niveau et la zone geographique.`;
            }

            document.title = title;

            const metaDescription = document.getElementById('metaDescription');
            if (metaDescription) metaDescription.setAttribute('content', description);

            const ogTitle = document.getElementById('ogTitle');
            if (ogTitle) ogTitle.setAttribute('content', title);

            const ogDescription = document.getElementById('ogDescription');
            if (ogDescription) ogDescription.setAttribute('content', description);

            if (ogUrl) ogUrl.setAttribute('content', pageUrl);

            const twitterTitle = document.getElementById('twitterTitle');
            if (twitterTitle) twitterTitle.setAttribute('content', title);

            const twitterDescription = document.getElementById('twitterDescription');
            if (twitterDescription) twitterDescription.setAttribute('content', description);

            if (canonical) canonical.setAttribute('href', 'https://www.meilleureecole.fr/search');
            if (alternate) alternate.setAttribute('href', 'https://www.meilleureecole.fr/search');

            const structuredDataEl = document.getElementById('structuredData');
            if (structuredDataEl) {
                const structuredData = {
                    "@context": "https://schema.org",
                    "@type": "SearchResultsPage",
                    "name": title,
                    "url": pageUrl,
                    "description": description,
                    "isPartOf": {
                        "@type": "WebSite",
                        "name": "MeilleureEcole.fr",
                        "url": "https://www.meilleureecole.fr/"
                    }
                };
                if (searchTerm) structuredData.searchTerm = searchTerm;
                if (typeof total === 'number') structuredData.numberOfItems = total;
                structuredDataEl.textContent = JSON.stringify(structuredData, null, 2);
            }
        }

        function resolveMetaType(filters) {
            if (filters && Array.isArray(filters.schoolTypes) && filters.schoolTypes.length === 1) {
                return filters.schoolTypes[0];
            }
            if (FILTER_TYPE_OPTIONS.has(initialType)) {
                return initialType;
            }
            return null;
        }

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const initialQuery = urlParams.get('q');
        const initialType = urlParams.get('type');
        const initialArea = urlParams.get('area');
        
        // Initialize page based on URL parameters
        function initializePage() {
            // Set page title based on parameters
            if (initialType) {
                document.getElementById('pageTitle').textContent = getTypeTitle(initialType);
                document.getElementById('searchSubtitle').textContent = getTypeSubtitle(initialType);
                setInitialTypeFilter(initialType);
            } else if (initialArea) {
                document.getElementById('pageTitle').textContent = `Etablissements a ${initialArea}`;
                document.getElementById('searchSubtitle').textContent = `Consultez tous les etablissements de ${initialArea}`;
                document.getElementById('locationInput').value = initialArea;
            } else if (initialQuery) {
                document.getElementById('searchInput').value = initialQuery;
            }

            updateSearchMeta({
                query: initialQuery && !initialArea ? initialQuery : '',
                area: initialArea || '',
                type: FILTER_TYPE_OPTIONS.has(initialType) ? initialType : null,
                total: 0
            });

            // Load initial results
            searchSchools();
        }
        
        function getTypeTitle(type) {
            const titles = {
                'primary': 'Ecoles maternelles et elementaires',
                'secondary': 'Colleges et lycees',
                'sixth-form': 'Lycees post-bac',
                'special': 'Etablissements specialises',
                'independent': 'Etablissements prives',
                'academy': 'Etablissements sous contrat'
            };
            return titles[type] || "Recherche d'établissements";
        }
        
        function getTypeSubtitle(type) {
            const subtitles = {
                'primary': 'Reperez les ecoles maternelles et elementaires pour les ages 3-11',
                'secondary': 'Selectionnez un college ou un lycee (11-18 ans)',
                'sixth-form': 'Trouvez un lycee post-bac ou une formation superieure',
                'special': 'Identifiez un etablissement specialise ou adapte',
                'independent': 'Decouvrez les etablissements prives disponibles',
                'academy': 'Explorez les etablissements sous contrat'
            };
            return subtitles[type] || "Trouvez l'etablissement adapte a votre projet";
        }
        
        function setInitialTypeFilter(type) {
            const checkbox = document.getElementById(`type-${type}`);
            if (checkbox) {
                checkbox.checked = true;
            }
        }
        
        // Search function
        async function searchSchools(page = 1) {
            currentPage = page;
            const offset = (page - 1) * resultsPerPage;
            
            // Show loading
            if (currentView === 'list') {
                document.getElementById('resultsList').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des etablissements...</p>
                    </div>
                `;
            }
            
            // Build query parameters
            const params = new URLSearchParams();
            
            const searchQuery = document.getElementById('searchInput').value;
            const locationQuery = document.getElementById('locationInput').value;
            
            if (searchQuery) {
                params.append('q', searchQuery);
                params.append('type', 'name');
            } else if (locationQuery) {
                params.append('q', locationQuery);
                params.append('type', 'location');
            } else if (initialArea) {
                params.append('q', initialArea);
                params.append('type', 'location');
            } else {
                // Default search - get all schools (French dataset)
                params.append('q', 'ecole');
                params.append('type', 'all');
            }
            
            params.append('limit', resultsPerPage);
            params.append('offset', offset);
            
            // Add filters (French)
            const filters = getActiveFilters();
            if (filters.categories.length > 0) {
                params.append('categories', filters.categories.join(','));
            }
            if (filters.statuses.length > 0) {
                params.append('status', filters.statuses.join(','));
            }
            if (filters.flags.length > 0) {
                params.append('flags', filters.flags.join(','));
            }
            if (filters.minRating) {
                params.append('minRating', filters.minRating);
            }
            
            try {
                const response = await fetch(`/api/search?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    searchResults = data.schools || [];
                    totalResults = data.total || 0;
                    displayResults();
                    updatePagination();
                    updateResultsCount();

                    const metaQuery = searchQuery ? searchQuery.trim() : '';
                    const metaArea = locationQuery ? locationQuery.trim() : (initialArea || '');
                    const metaType = resolveMetaType(filters);
                    updateSearchMeta({
                        query: metaQuery,
                        area: metaQuery ? '' : metaArea,
                        type: metaType,
                        total: totalResults
                    });

                    if (currentView === 'map') {
                        updateMap();
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la recherche :', error);
                displayError();
            }
        }
        
        // Search for schools in map bounds
        async function searchInMapBounds() {
            if (!map) return;
            
            const bounds = map.getBounds();
            const center = bounds.getCenter();
            
            // Add loading state to button
            const searchBtn = document.querySelector('.map-search-control');
            if (searchBtn) {
                searchBtn.classList.add('loading');
                searchBtn.innerHTML = '⏳ Searching...';
            }
            
            try {
                // Search using center coordinates
                const params = new URLSearchParams();
                params.append('lat', center.lat);
                params.append('lng', center.lng);
                params.append('radius', '10'); // 10km radius
                params.append('limit', '100'); // Get more results for map
                
                const response = await fetch(`/api/search/nearby?${params}`);
                const data = await response.json();
                
                if (data.success && data.schools) {
                    searchResults = data.schools;
                    totalResults = data.schools.length;

                    // Update both map and list
                    updateMap();
                    displayResults();
                    updateResultsCount();

                    const filters = getActiveFilters();
                    const metaQuery = document.getElementById('searchInput').value.trim();
                    const metaArea = document.getElementById('locationInput').value.trim() || initialArea || '';
                    updateSearchMeta({
                        query: metaQuery,
                        area: metaQuery ? '' : metaArea,
                        type: resolveMetaType(filters),
                        total: totalResults
                    });

                    // Show notification
                    showNotification(`${totalResults} etablissements trouves dans cette zone`);
                }
            } catch (error) {
                console.error('Erreur lors de la recherche sur la carte :', error);
                showNotification('Erreur lors de la recherche dans cette zone', 'error');
            } finally {
                // Reset button
                if (searchBtn) {
                    searchBtn.classList.remove('loading');
                    searchBtn.innerHTML = 'Rechercher dans cette zone';
                }
            }
        }
        
        function getActiveFilters() {
            const filters = {
                categories: [],
                statuses: [],
                flags: [],
                minRating: null
            };
            
            // Types d'etablissements
            document.querySelectorAll('#schoolTypeFilters input:checked').forEach(checkbox => {
                filters.categories.push(checkbox.value);
            });
            
            // Statut public/prive
            document.querySelectorAll('#statusFilters input:checked').forEach(checkbox => {
                filters.statuses.push(checkbox.value);
            });
            // Autres criteres (flags)
            document.querySelectorAll('#flagFilters input:checked').forEach(checkbox => {
                filters.flags.push(checkbox.value);
            });
            
            // Overall rating
            const ratingRange = document.getElementById('ratingRange').value;
            if (ratingRange > 1) {
                filters.minRating = ratingRange;
            }
            
            return filters;
        }
        
        function displayResults() {
            if (!searchResults || searchResults.length === 0) {
                document.getElementById('resultsList').innerHTML = `
                    <div class="no-results">
                        <h3>Aucun etablissement trouve</h3>
                        <p>Modifiez vos filtres ou votre recherche</p>
                    </div>
                `;
                return;
            }
            
            const html = searchResults.map(school => {
                const rating = school.overall_rating ? parseFloat(school.overall_rating) : null;
                const ratingClass = getRatingClass(rating);
                const statut = school.statut_public_prive || school.phase_of_education || '';
                // Format rating display - just show the number without decimals if it's 10
                let ratingDisplay = 'N/A';
                if (rating !== null) {
                    ratingDisplay = rating >= 10 ? '10' : rating.toFixed(1);
                }
                return `
                    <div class="school-card" onclick="window.location.href='${schoolPathFromData(school)}'">
                        <div class="school-card-header">
                            <div>
                                <div class="school-card-name">${school.name}</div>
                                <div class="school-card-type">
                                    ${school.type_of_establishment || ''}${statut ? ` · ${statut}` : ''}
                                </div>
                            </div>
                            <div class="school-card-rating rating-${ratingClass}">
                                ${ratingDisplay}/10
                            </div>
                        </div>
                        <div class="school-card-details">
                            <div class="detail-item">
                                <span class="detail-label">COMMUNE</span>
                                <span>${[school.postcode, school.town].filter(Boolean).join(' ') || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">DEPARTEMENT</span>
                                <span>${school.departement || '-'}${school.region ? ` (${school.region})` : ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">STATUT</span>
                                <span>${statut || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">EFFECTIF</span>
                                <span>${school.number_of_students || school.number_on_roll ? `${formatNumber(school.number_of_students || school.number_on_roll)} eleves` : 'Effectif inconnu'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('resultsList').innerHTML = html;
        }
        
        function updateResultsCount() {
            document.getElementById('resultsCount').textContent = totalResults;
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(totalResults / resultsPerPage);
            if (totalPages <= 1) {
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} 
                     onclick="searchSchools(${currentPage - 1})">Precedent</button>`;
            
            // Page numbers
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                         onclick="searchSchools(${i})">${i}</button>`;
            }
            
            if (totalPages > 5) {
                html += `<span class="page-btn" disabled>...</span>`;
                html += `<button class="page-btn ${totalPages === currentPage ? 'active' : ''}" 
                         onclick="searchSchools(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} 
                     onclick="searchSchools(${currentPage + 1})">Suivant</button>`;
            
            document.getElementById('pagination').innerHTML = html;
        }
        
        function toggleView(view) {
            currentView = view;
            
            // Update buttons
            const _btns = Array.from(document.querySelectorAll('.view-btn')); _btns.forEach(b=>b.classList.remove('active')); if (view === 'map' && _btns[1]) { _btns[1].classList.add('active'); } else if (_btns[0]) { _btns[0].classList.add('active'); }
            
            // Toggle views
            if (view === 'map') {
                document.getElementById('resultsList').classList.remove('active');
                document.getElementById('schoolsMap').classList.add('active');
                initializeMap();
                updateMap();
            } else {
                document.getElementById('schoolsMap').classList.remove('active');
                document.getElementById('resultsList').classList.add('active');
            }
        }
        
        function initializeMap() {
            if (!isMapInitialized) {
                map = L.map('schoolsMap').setView([46.6, 2.4], 6); // France center
                if (window.getDefaultTileLayer) {
                  window.getDefaultTileLayer(map);
                } else {
                  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                      attribution: '© OpenStreetMap contributors, © CARTO',
                      maxZoom: 19,
                      subdomains: 'abcd'
                  }).addTo(map);
                }
                
                // Add marker cluster group
                markers = L.markerClusterGroup({
                    chunkedLoading: true,
                    maxClusterRadius: 50
                });
                map.addLayer(markers);
                
                // Add search button
                const searchControl = L.Control.extend({
                    options: {
                        position: 'topleft'
                    },
                    onAdd: function(map) {
                        const div = L.DomUtil.create('div', 'map-search-control');
                        div.innerHTML = 'Rechercher dans cette zone';
                        div.onclick = searchInMapBounds;
                        L.DomEvent.disableClickPropagation(div);
                        return div;
                    }
                });
                
                map.addControl(new searchControl());
                
                isMapInitialized = true;
            }
            
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }
        
        function updateMap() {
            if (!map || !isMapInitialized) return;
            
            // Clear existing markers
            markers.clearLayers();
            
            // Add markers for schools with coordinates
            const validSchools = [];
            const missingCoords = [];
            
            searchResults.forEach(school => {
                // Check for latitude/longitude in the school data
                if (school.latitude && school.longitude) {
                    const lat = parseFloat(school.latitude);
                    const lng = parseFloat(school.longitude);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        validSchools.push(school);
                        
                        const rating = school.overall_rating ? parseFloat(school.overall_rating) : null;
                        const ratingClass = getRatingClass(rating);
                        
                        // Format rating display
                        let ratingDisplay = '?';
                        if (rating !== null) {
                            ratingDisplay = rating >= 10 ? '10' : rating.toFixed(1);
                        }
                        
                        // Create custom icon
                        const icon = L.divIcon({
                            className: `school-marker ${ratingClass}`,
                            html: ratingDisplay,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });
                        
                        const marker = L.marker([lat, lng], { icon })
                            .bindPopup(`
                                <strong>${school.name}</strong><br>
                                Note : ${ratingDisplay}/10<br>
                                ${school.type_of_establishment || 'Etablissement'}<br>
                                <a href="${schoolPathFromData(school)}">Voir la fiche</a>
                            `);
                        
                        markers.addLayer(marker);
                    }
                } else {
                    missingCoords.push(school);
                }
            });
            
            // Fit map to markers if we have any
            if (validSchools.length > 0) {
                const bounds = markers.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
                console.log(`Cartographie realisee pour ${validSchools.length} etablissements`);
            } else if (searchResults.length > 0) {
                // No schools have coordinates, show a message
                console.log(`Aucune coordonnee disponible pour ${searchResults.length} etablissements`);
                showNotification('Les donnees cartographiques ne sont pas disponibles pour ces etablissements', 'info');
                
                // Try to center on the general area if we know it
                const locationQuery = document.getElementById('locationInput').value;
                if (locationQuery) {
                    // You could geocode the location here
                    console.log('Geocodage a realiser :', locationQuery);
                }
            }
            
            if (missingCoords.length > 0) {
                console.log(`${missingCoords.length} etablissements sans coordonnees`);
            }
        }
        
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('locationInput').value = '';
            document.querySelectorAll('.filters-sidebar input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('ratingRange').value = 5;
            document.getElementById('ratingValue').textContent = '5';
            searchSchools();
        }
        
        function displayError() {
            document.getElementById('resultsList').innerHTML = `
                <div class="no-results">
                    <h3>Erreur lors du chargement des resultats</h3>
                    <p>Veuillez reessayer plus tard</p>
                </div>
            `;
        }
        
        function getRatingClass(rating) {
            if (!rating) return 'average';
            if (rating >= 8) return 'excellent';
            if (rating >= 6) return 'good';
            if (rating >= 4) return 'satisfactory';
            return 'poor';
        }
        
        function getOfstedLabel(rating) {
            const labels = {
                1: 'Excellent',
                2: 'Bon',
                3: 'A ameliorer',
                4: 'Insuffisant'
            };
            return labels[rating] || 'Non inspecte';
        }
        
        function formatNumber(num) {
            if (!num) return 'N/A';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ef4444' : '#2563eb'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Event listeners
        document.getElementById('searchInput').addEventListener('input', debounce(() => searchSchools(), 500));
        document.getElementById('locationInput').addEventListener('input', debounce(() => searchSchools(), 500));
        
        document.querySelectorAll('#schoolTypeFilters input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => searchSchools());
        });
        
        document.querySelectorAll('#statusFilters input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => searchSchools());
        });
        
        document.getElementById('ratingRange').addEventListener('input', function() {
            document.getElementById('ratingValue').textContent = this.value;
        });
        
        document.getElementById('ratingRange').addEventListener('change', () => searchSchools());
        
        // Extra flags listeners
        document.querySelectorAll('#flagFilters input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => searchSchools());
        });
        
        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>

