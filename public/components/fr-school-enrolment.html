<!-- fr-school-enrolment.html -->
<div class="section-card">
  <div class="section-header">
    <h2 class="section-title">Effectifs</h2>
  </div>
  <div id="frEnrolmentSummary" class="enrol-summary">Effectif total : <strong id="frTotalEleves">-</strong></div>
  <canvas id="frEnrolmentCanvas" height="200" style="max-width:100%; height:220px; margin-top: 1rem;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  function set(id, v){ var el=document.getElementById(id); if(el) el.textContent=v; }
  let chart;
  function renderChart(total, avg){
    const ctx = document.getElementById('frEnrolmentCanvas');
    if (!ctx || !window.Chart) return;
    // Avoid stacking multiple charts on same canvas
    if (window.Chart && typeof window.Chart.getChart === 'function') {
      const existing = window.Chart.getChart(ctx);
      if (existing) existing.destroy();
    }
    const data = {
      labels: ['Etablissement', 'Moyenne departement'],
      datasets: [{
        label: 'Nombre d\'eleves',
        data: [total ?? null, avg ?? null],
        backgroundColor: ['#2563eb', '#9ca3af']
      }]
    };
    const options = {
      responsive: true,
      maintainAspectRatio: true,
      animation: false,
      resizeDelay: 0,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    };
    if (chart) { chart.data = data; chart.options = options; chart.update(); }
    else { chart = new Chart(ctx, { type: 'bar', data, options }); }
  }
  async function loadByLevel(s) {
    if (!s || !s.urn) return null;
    const te = (s.type_etablissement || s.type || '').toLowerCase();
    let type = null;
    if (te.includes('coll')) type = 'college';
    else if (te.includes('pro')) type = 'lycee_pro';
    else if (te.includes('lyc')) type = 'lycee_gt';
    if (!type) return null;
    try {
      const resp = await fetch(`/api/fr/effectifs/${encodeURIComponent(s.urn)}?type=${type}`);
      const data = await resp.json();
      if (!data || !data.success) return null;
      return data;
    } catch(_) { return null; }
  }

  function render(s){
    if(!s) return;
    const total = (s.enrolment_stats && s.enrolment_stats.total) || s.number_of_students || (s.demographics && s.demographics.total_students);
    if(total!=null) set('frTotalEleves', Number(total).toLocaleString('fr-FR'));
    const avg = s.enrolment_stats && s.enrolment_stats.departement_average;
    renderChart(total, avg);
    // Fetch richer breakdown when available
    loadByLevel(s).then((dataset) => {
      if (!dataset || !dataset.by_level) return;
      const ORDER = ['6e','5e','4e','3e','ULIS','SEGPA'];
      const keys = Object.keys(dataset.by_level);
      const labels = ORDER.filter(k => keys.includes(k)).concat(keys.filter(k => !ORDER.includes(k)));
      const values = labels.map(k => dataset.by_level[k]);
      const ctx = document.getElementById('frEnrolmentCanvas');
      if (!ctx || !window.Chart) return;
      if (window.Chart && typeof window.Chart.getChart === 'function') {
        const existing = window.Chart.getChart(ctx);
        if (existing) existing.destroy();
      }
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: `Effectifs (${dataset.year || ''})`, data: values, backgroundColor: '#2563eb' }] },
        options: { responsive: true, maintainAspectRatio: true, animation: false, resizeDelay: 0, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
      });
    });
  }
  if(window.currentSchoolData) render(window.currentSchoolData);
  window.addEventListener('schoolDataLoaded', e=>render(e.detail));
})();
</script>

