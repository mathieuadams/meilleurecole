<!-- fr-school-enrolment.html -->
<div class="section-card">
  <div class="section-header">
    <h2 class="section-title">Effectifs</h2>
  </div>
  <div id="frEnrolmentSummary" class="enrol-summary">Effectif total : <strong id="frTotalEleves">-</strong></div>
  <canvas id="frEnrolmentCanvas" height="200" style="max-width:100%; height:220px; margin-top: 1rem;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  function set(id, v){ var el=document.getElementById(id); if(el) el.textContent=v; }
  let chart;
  function ensureChartJs(){
    if (window.Chart) return Promise.resolve();
    return new Promise((resolve) => {
      const src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      const tag = document.querySelector(`script[src="${src}"]`);
      const done = () => resolve();
      if (window.Chart) return resolve();
      if (tag) {
        tag.addEventListener('load', done, { once: true });
        // Also poll in case load already fired
        const t = setInterval(() => { if (window.Chart) { clearInterval(t); resolve(); } }, 50);
        setTimeout(() => clearInterval(t), 3000);
      } else {
        const s = document.createElement('script');
        s.src = src; s.onload = done; document.body.appendChild(s);
      }
    });
  }
  function detectType(s){
    const te = (s.type_etablissement || s.type || '').toLowerCase();
    if (te.includes('coll')) return 'college';
    if (te.includes('pro')) return 'lycee_pro';
    if (te.includes('lyc')) return 'lycee_gt';
    return null;
  }
  async function renderChart(total, avg){
    const ctx = document.getElementById('frEnrolmentCanvas');
    if (!ctx) return;
    await ensureChartJs();
    // Avoid stacking multiple charts on same canvas
    if (window.Chart && typeof window.Chart.getChart === 'function') {
      const existing = window.Chart.getChart(ctx);
      if (existing) existing.destroy();
    }
    const data = {
      labels: ['Etablissement', 'Moyenne departement'],
      datasets: [{
        label: 'Nombre d\'eleves',
        data: [total ?? null, avg ?? null],
        backgroundColor: ['#2563eb', '#9ca3af']
      }]
    };
    const options = {
      responsive: true,
      maintainAspectRatio: true,
      animation: false,
      resizeDelay: 0,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    };
    if (chart) { chart.data = data; chart.options = options; chart.update(); }
    else { chart = new Chart(ctx, { type: 'bar', data, options }); }
  }
  async function loadByLevel(s) {
    if (!s || !s.urn) return null;
    const type = detectType(s);
    if (!type) return null;
    try {
      const resp = await fetch(`/api/fr/effectifs/${encodeURIComponent(s.urn)}?type=${type}`);
      const data = await resp.json();
      if (!data || !data.success) return null;
      return data;
    } catch(_) { return null; }
  }

  async function loadHistory(s){
    if (!s || !s.urn) return null;
    const type = detectType(s);
    if (!type) return null;
    try {
      const resp = await fetch(`/api/fr/effectifs/${encodeURIComponent(s.urn)}/history?type=${type}`);
      const data = await resp.json();
      if (!data || !data.success) return null;
      return data; // { series: [{year,total}], latest_year }
    } catch(_) { return null; }
  }

  function render(s){
    if(!s) return;
    const total = (s.enrolment_stats && s.enrolment_stats.total) || s.number_of_students || (s.demographics && s.demographics.total_students);
    if(total!=null) set('frTotalEleves', Number(total).toLocaleString('fr-FR'));
    const avg = s.enrolment_stats && s.enrolment_stats.departement_average;
    renderChart(total, avg);

    // Try to render a line chart of total students by year
    loadHistory(s).then((hist) => {
      if (!hist || !Array.isArray(hist.series) || !hist.series.length) return;
      // If summary missing, fill it first
      if (total==null) {
        const last = hist.series[hist.series.length-1];
        if (last && last.total!=null) set('frTotalEleves', Number(last.total).toLocaleString('fr-FR'));
      }
      const labels = hist.series.map(p => p.year);
      const values = hist.series.map(p => p.total);
      const ctx = document.getElementById('frEnrolmentCanvas');
      if (!ctx) return;
      ensureChartJs().then(() => {
        if (window.Chart && typeof window.Chart.getChart === 'function') {
          const existing = window.Chart.getChart(ctx);
          if (existing) existing.destroy();
        }
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Effectifs totaux', data: values, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', tension: 0.2, fill: true, pointRadius: 3 }] },
          options: { responsive: true, maintainAspectRatio: true, animation: false, resizeDelay: 0, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
        });
      });
    });
  }
  if(window.currentSchoolData) render(window.currentSchoolData);
  window.addEventListener('schoolDataLoaded', e=>render(e.detail));
})();
</script>
