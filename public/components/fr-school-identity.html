<!-- fr-school-identity.html -->
<section class="profile-header">
  <div class="container">
    <div class="profile-header-content">
      <div>
        <h1 id="frSchoolName">Etablissement</h1>
        <div class="school-type-info" id="frTypeRow" style="gap:.5rem; flex-wrap: wrap;">
          <span class="badge" id="frType">-</span>
          <span class="badge" id="frStatut">-</span>
          <span class="badge" id="frDepartement">-</span>
          <span class="badge badge-neutral" id="frStudents">â€” Ã©lÃ¨ves</span>
        </div>
        <div class="school-address-info">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
          </svg>
          <span id="frAddress">Adresse â€¢ Commune â€¢ CP</span>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
.badge{background:#eef2ff;color:#3730a3;padding:2px 8px;border-radius:999px;font-size:.75rem;font-weight:600}
.badge-neutral{background:#f3f4f6;color:#374151}
</style>

<script>
(function(){
  function set(elId, value){ var el=document.getElementById(elId); if(el) el.textContent = value || '-'; }
  function fullFRAddress(s){
    var a1 = s.adresse_ligne1 || s.adresse_1 || s.street;
    var a2 = s.adresse_ligne2 || s.adresse_2 || s.locality;
    var a3 = s.adresse_ligne3 || s.adresse_3;
    var parts = [a1, a2, a3, s.postcode || s.code_postal, s.town || s.nom_commune].filter(Boolean);
    return parts.join(' ');
  }
  async function fetchEffectifTotalIfMissing(data){
    var current = (data.enrolment_stats && data.enrolment_stats.total) || (data.demographics && data.demographics.total_students) || data.number_of_students;
    if (current != null) return current;
    var te = (data.type_etablissement || data.type || '').toLowerCase();
    var type = null;
    if (te.includes('coll')) type = 'college';
    else if (te.includes('pro')) type = 'lycee_pro';
    else if (te.includes('lyc')) type = 'lycee_gt';
    if (!type) return null;
    try {
      var resp = await fetch('/api/fr/effectifs/' + encodeURIComponent(data.urn) + '?type=' + type);
      var payload = await resp.json();
      if (payload && payload.success && payload.total != null) return payload.total;
    } catch (e) { }
    return null;
  }
  async function renderHeader(data){
    if(!data) return;
    set('frSchoolName', data.name);
    set('frType', (data.type_etablissement || data.type || data.type_of_establishment || '').trim());
    set('frStatut', (data.statut_public_prive || data.phase || data.phase_of_education || '').trim());
    try { set('frDepartement', (data.address && (data.address.local_authority || data.address.county)) || ''); } catch {}
    var addr = data.address || {};
    set('frAddress', fullFRAddress({
      adresse_ligne1: data.adresse_ligne1, adresse_ligne2: data.adresse_ligne2, adresse_ligne3: data.adresse_ligne3,
      postcode: data.postcode || data.code_postal || addr.postcode, town: data.town || data.nom_commune || addr.town,
      street: addr.street, locality: addr.locality
    }));
    var total = (data.enrolment_stats && data.enrolment_stats.total) || (data.demographics && data.demographics.total_students) || data.number_of_students;
    if (total == null) total = await fetchEffectifTotalIfMissing(data);
    var label = (total!=null) ? (Number(total).toLocaleString('fr-FR') + ' eleves') : '— eleves';
    set('frStudents', label);
  }
  if(window.currentSchoolData) renderHeader(window.currentSchoolData);
  window.addEventListener('schoolDataLoaded', function(e){ renderHeader(e.detail); });
})();
</script>

